---
import { getEntry } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import StatsSection from '../components/blocks/StatsSection';

// Register block components
const BLOCK_COMPONENTS = {
  StatsSection,
};

// Get the homepage content
const pageEntry = await getEntry('pages', 'homepage');

if (!pageEntry) {
  // Fallback to overview if homepage doesn't exist
  const overviewEntry = await getEntry('pages', 'overview');
  if (overviewEntry) {
    return Astro.redirect('/overview');
  }
  return Astro.redirect('/404');
}

// Load all block content for this page
const blocks = await Promise.all(
  pageEntry.data.blocks.map(async (block: any) => {
    try {
      const content = await getEntry('blocks', block.content);
      if (!content) {
        console.warn(`Block content not found: ${block.content}`);
        return null;
      }
      
      const Component = BLOCK_COMPONENTS[block.type as keyof typeof BLOCK_COMPONENTS];
      if (!Component) {
        console.warn(`Block component not found: ${block.type}`);
        return null;
      }
      
      return {
        type: block.type,
        content: content.data,
        Component,
        variant: block.variant,
      };
    } catch (error) {
      console.error(`Error loading block ${block.content}:`, error);
      return null;
    }
  })
);

// Filter out any null blocks
const validBlocks = blocks.filter(Boolean);
---

<BaseLayout 
  title={`${pageEntry.data.title} - OpenAI Sidebar Template`}
  description={pageEntry.data.description}
>
  <div>
    <h1 class="text-4xl font-semibold text-content-primary mb-8">
      {pageEntry.data.title}
    </h1>
    
    {validBlocks.length > 0 ? (
      <div class="space-y-12">
        {validBlocks.map((block, index) => {
          const { Component, content } = block;
          if (block.type === 'StatsSection') {
            return (
              <div key={index} class="block-wrapper">
                <div class="w-full h-1 bg-orange-500 my-8" style="; height: 4px;"></div>
                <StatsSection content={content} client:load />
                <div class="w-full h-1 bg-orange-500 my-8" style="; height: 4px;"></div>
              </div>
            );
          }
          return null;
        })}
      </div>
    ) : (
      <p class="text-content-secondary">
        Welcome to the OpenAI Sidebar Template. Configure your homepage blocks to get started.
      </p>
    )}
  </div>
</BaseLayout>